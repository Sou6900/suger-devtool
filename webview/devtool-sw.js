 let instrumentationEnabled=!1,instrumentedCache=new Map,pendingInstrumentation=new Map;async function handleJSRequest(e,n){try{if(instrumentedCache.has(n.href))return new Response(instrumentedCache.get(n.href),{headers:{"Content-Type":"application/javascript"}});const t=await fetch(e);if(!t.ok)return t;const a=await t.text(),s=await requestInstrumentation(n.href,a);return new Response(s,{headers:{"Content-Type":"application/javascript"}})}catch(n){return fetch(e)}}async function requestInstrumentation(e,n){const t=new Promise((n=>{pendingInstrumentation.set(e,n)}));if(!await sendToMainThread({type:"INSTRUMENT_REQUEST",data:{url:e,code:n}}))return pendingInstrumentation.delete(e),n;const a=new Promise((t=>{setTimeout((()=>{pendingInstrumentation.has(e)&&(pendingInstrumentation.delete(e),t(n))}),2e3)}));return Promise.race([t,a])}async function sendToMainThread(e){const n=await self.clients.matchAll({includeUncontrolled:!0,type:"window"});let t=n.find((e=>"visible"===e.visibilityState))||n[0];return!!t&&(t.postMessage(e),!0)}self.addEventListener("install",(e=>{self.skipWaiting()})),self.addEventListener("activate",(e=>{e.waitUntil(self.clients.claim())})),self.addEventListener("message",(async e=>{if(!e.data)return;const{type:n,enabled:t,url:a,code:s}=e.data;switch(n){case"SET_INSTRUMENTATION":instrumentationEnabled=t,t||(instrumentedCache.clear(),pendingInstrumentation.clear());break;case"CACHE_INSTRUMENTED":if(a&&s&&(instrumentedCache.set(a,s),pendingInstrumentation.has(a))){const e=pendingInstrumentation.get(a);pendingInstrumentation.delete(a),e(s)}break;case"CLEAR_CACHE":instrumentedCache.clear(),pendingInstrumentation.clear()}})),self.addEventListener("fetch",(e=>{const n=new URL(e.request.url);"navigate"!==e.request.mode&&"document"!==e.request.destination&&n.origin===self.location.origin&&(e.request.headers.has("X-DevTool-Request")||n.pathname.includes("devtool-sw.js")||n.pathname.includes("suger-dev")||n.pathname.includes("socket")||instrumentationEnabled&&n.pathname.endsWith(".js")&&e.respondWith(handleJSRequest(e.request,n)))}));
