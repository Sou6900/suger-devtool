let instrumentationEnabled=!1,instrumentedCache=new Map,pendingInstrumentation=new Map;async function handleJSRequest(e,t){try{if(instrumentedCache.has(t.href))return new Response(instrumentedCache.get(t.href),{headers:{"Content-Type":"application/javascript"}});const n=await fetch(e);if(!n.ok)return console.error(`[SW] ❌ Fetch failed: ${t.pathname}`,n.status),n;const a=await n.text(),s=await requestInstrumentation(t.href,a);return new Response(s,{headers:{"Content-Type":"application/javascript"}})}catch(n){return console.error(`[SW] ❌ Error handling JS ${t.pathname}:`,n),fetch(e)}}async function handleHTMLRequest(e,t){try{if(instrumentedCache.has(t.href))return new Response(instrumentedCache.get(t.href),{headers:{"Content-Type":"text/html"}});const n=await fetch(e);if(!n.ok)return console.error(`[SW] ❌ Fetch failed: ${t.pathname}`,n.status),n;const a=n.headers.get("Content-Type");if(!a||!a.includes("text/html"))return n;const s=await n.text(),r=await requestInstrumentation(t.href,s,!0);return new Response(r,{headers:{"Content-Type":"text/html"}})}catch(n){return console.error(`[SW] ❌ Error handling HTML ${t.pathname}:`,n),fetch(e)}}async function requestInstrumentation(e,t,n=!1){const a=new Promise((t=>{pendingInstrumentation.set(e,t)}));await sendToMainThread({type:n?"INSTRUMENT_HTML_REQUEST":"INSTRUMENT_REQUEST",data:{url:e,code:t}});const s=new Promise((n=>{setTimeout((()=>{pendingInstrumentation.delete(e),n(t)}),5e3)}));return Promise.race([a,s])}async function sendToMainThread(e){const t=await self.clients.matchAll();t.length>0?t[0].postMessage(e):console.error("[SW] ❌ No main thread client found!")}self.addEventListener("install",(e=>{self.skipWaiting()})),self.addEventListener("activate",(e=>{e.waitUntil(self.clients.claim())})),self.addEventListener("message",(async e=>{const{type:t,enabled:n,url:a,code:s,breakpoints:r}=e.data;switch(t){case"SET_INSTRUMENTATION":instrumentationEnabled=n,n||(instrumentedCache.clear(),pendingInstrumentation.clear());break;case"CACHE_INSTRUMENTED":if(instrumentedCache.set(a,s),pendingInstrumentation.has(a)){const e=pendingInstrumentation.get(a);pendingInstrumentation.delete(a),e(s)}break;case"SYNC_BREAKPOINTS":break;case"CLEAR_CACHE":instrumentedCache.clear(),pendingInstrumentation.clear()}})),self.addEventListener("fetch",(e=>{const t=new URL(e.request.url);if(e.request.headers.has("X-DevTool-Request"))return;if(t.origin!==self.location.origin)return;if(t.pathname.includes("devtool-sw.js")||t.pathname.includes("sc-dt.core.js")||t.pathname.includes("devtool-bootstrap.js"))return;if(!instrumentationEnabled)return;const n=e.request.headers.get("Accept")||"";t.pathname.endsWith(".js")?e.respondWith(handleJSRequest(e.request,t)):("navigate"===e.request.mode||n.includes("text/html")&&!t.pathname.endsWith(".js"))&&e.respondWith(handleHTMLRequest(e.request,t))}));
